( aux )                                                         : cc page clearstacks ; : ]l ] postpone literal ;               : v: variable ; : 2v: 2variable ; : 0! 0 swap ! ;               : c: constant ; : 2c: 2constant ; : 3drop 2drop drop ;          : 1= 1 = ; : 2= 2 = ; : 2+ 2 + ; : 2- 2 - ; : not invert ;      : i+ i + ; : i- i - ; : ++ rot + -rot + swap ;                  : s>num s>number drop ; : even 2 mod 0= ; : odd 2 mod 0<> ;     : sort 2dup max -rot min ; : -sort 2dup min -rot max ;                                                                          : bl? bl = ; : esc? dup 27 = ; : bksp? dup 127 = ;              : digit? '0 '9 1+ within ;                                                                                                      : +- dup even if 1+ else 1- then ;                                                                                                                                                                                                                              ( auxiliary definitions                                                                                                          ]l is equivalent to ] literal                                   winw/h give window width/height                                 ++ stack effect => n1 n2 n3 n4 => n1+n3 n2+n4                   sort/-sort => sort 2 numbers in proper or reverse order )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( files -- rework )                                             2v: fname  v: file                                              : fname" bl word count ; : fmake r/w create-file ;              : fopen r/w open-file ; : fmake drop fmake throw file ! ;       : fopen 2dup fopen 0= if file ! 2drop exit then fmake ;         : fwrite file @ write-file throw ; ( appends )                  : fclose file @ close-file throw ;                              : "write fopen fwrite fclose ;                                  : write" fname" "write ; ( buf len "file )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( file writing utilities                                                                                                        this stuff was taken from a previous "library" and is used here temporarily until i better integrate this editor with the provided block words of gforth. )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( colors )                                                      30 c: black  31 c: red      32 c: green   33 c: yellow          34 c: blue   35 c: magenta  36 c: cyan    37 c: white           : digs 10 /mod '0 + swap '0 + swap emit emit ;                  : colo esc[ digs 'm emit ; : bg 10 + ;                                                                                         2v: colr                                                       : swp colr 2@ swap colr 2! ; : colr@ colr @ ;                   : !remem colr@ swap colr 2! ; : colo> colr@ colo ;                                                                             : yellow! yellow colr ! ; : green! green colr ! ;               : white! white colr ! ; : red! red colr ! ;                                                                                     : blu blue colo ; : blubg blue bg colo ;                        : bnw black bg colo white colo ;                                                                                                ( colors                                                                                                                          there is some refactoring to do here, i believe. )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( boxes )                                                       : horiz 9473 xemit ; : topl 9487 xemit ; : topr 9491 xemit ;    : botr 9499 xemit ; : botl 9495 xemit ; : vert 9475 xemit ;                                                                     64 c: w  16 c: h  w h * c: len  2v: offs                        : .off offs 2@ ; : iff offs 2@ 1 1 ++ offs 2! ;                 : hor w 0 do horiz loop ;                                       : top .off at-xy topl hor topr ;                                : bot .off h 1+ + at-xy botl hor botr ;                         : ver 1+ 2dup at-xy vert w 0 at-deltaxy vert ;                  : ver .off h 0 do ver loop 2drop ;                              : box top ver bot ;                                                                                                            : bar 00xy blubg winw spaces 00xy .s bnw ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( cursor )                                                      v: buf  v: ind                                                  : lim 0 max len 1- min ; : ind! lim ind ! ;                     : pos ind @ w /mod ; : cur pos .off ++ ; : refr cur at-xy ;     : x+ ind @ 1+ ind! ; : x- ind @ 1- ind! ; : cx pos drop ;       : y+ ind @ w + ind! ; : y- ind @ w - ind! ; : cy pos nip ;      : x0 ind @ cx - ; : x$ ind @ w cx - 1- + ;                                                                                      : whe buf @ ind @ ; : where@ whe + ; : what where@ c@ ;         : bef whe 1- + c@ ; : aft whe 1+ + c@ ; : 2bef whe 2- + c@ ;    : beg? cx 0= ; : end? cx w 1- = ;                               : bob ind @ 0= ; : eob ind @ len 1- = ; : beob bob eob or ;     : buf@ buf @ len ;                                                                                                                                                                                                                                              (                                                                Cursor position is determined by:                               - the ind variable - always kept between 0 and 1023             - the offs 2variable                                                                                                            'pos' splits ind into an x and y value -- cx, cy                                                                                'buf' contains the address of the current block.                                                                                x0 and x$ show the value of 'ind' for the beggining and end of  the current line.                                                                                                               bob and eob check if at beggining or end of buffer. )                                                                                                                                                                                                          ( syntax ) : @bl? what bl? ; : -bl what bl <> ; 2v: @syn        : !rem @syn @ swap @syn 2! ; : rem @syn 1 cells + @ @syn ! ;    : bef? bef bl? ; : aft? aft bl? ; : wrd? beg bef? or aft? and ; : what? what = wrd? and ;                                       : int @syn @ 0= if yellow! rdrop then ;                         : )com @bl? bef ') = and 2bef bl? and ; : )com )com if swp rem rdrop then ; : com @syn @ 1 = if white !remem )com rdrop then ;  : def @syn @ 2 = if red! rdrop then ;                           : cmp @syn @ 4 = if green! rdrop then ;                         : com? '( what? if 1 !rem rdrop then ;                          : def? ': what? if 2 @syn ! rdrop then ;                        : ent? @syn @ 2 = -bl? and if 3 @syn ! rdrop then ;             : cmp? @syn @ 3 = @bl? and if 4 @syn ! rdrop then ;             : int? '; what? if @syn 0! rdrop then ;                         : syn? int? com? def? ent? cmp? int? ;                          : syn syn? int com def cmp ; : syn syn colo> ;                  ( syntax highlighting                                                                                                            @syn [ double var ] -- value varies from 0 to 4:                0: interpret  -- yellow                                         1: comment    -- white                                          2: definition -- red                                            3: definition -- red -- inside definition and cur. char not bl  4: compile    -- green                                                                                                         com? def? ent? cmp? int? -- are ran in sequence until on is true and therefore changes the value of @syn.                                                                                      int com def cmp -- change colors, preserve previous colors.                                                                     !rem, rem, !remem -- remember previous values of @syn or colr or restore them from 2nd value of double variable. )             ( content ) 64 c: #blks  len #blks * c: size  v: #blk           create blocks here size bl fill size allot : fname s" blocks.4th" ; : >blocks ['] blocks >body ; : blk #blk ! blocks #blk @ len * + buf ! ; : blk% #blks mod blk ; : fsave >blocks size fname "write ; : blk+ #blk @ 2+ blk% ; : blk- #blk @ 2- blk% ; : file? fname slurp-file ; : fread file? >blocks swap move ; : run buf@ evaluate ; : run@ whe evaluate ; : nl y+ x0 ind! ; : nl? dup 13 = over 10 = or if nl drop rdrop then ;: put nl? syn emit x+ ; : wrt where@ c! ; : bksp? dup 127 = ; : putbl ind @ len ind! bl wrt ind! refr ; : prnt len 0 do refr buf @ i+ @ put loop ; : prnt ind 0! prnt ind 0! @syn 0! refr ; : bufcl buf @ len bl fill ; : prsrv ind @ prnt ind! refr ; : ibksp? bksp? if pull x- drop rdrop then ; : rbksp? bksp? if x- refr bl wrt bl emit refr drop rdrop then ; : push where@ whe 1+ + len ind @ - 1- cmove> prsrv ; : alt #blk @ +- blk ; : .ld #blk @ >r 2* blk run r> blk ; : .tru -sort 1+ swap do i .ld loop ; : shadw? #blk @ odd ;    7 .ld     s" touch blocks.4th" system   fread   0 blk                     ( This is in dire need of refactoring.                                                                                           put -- checks syntax, emits char, advances                      wrt -- stores char into buf                                     prnt -- runs put for all chars in buf                           ibksp? -- insert mode backspace                                 rbksp? -- replace mode backspace                                putbl -- puts one blank at last cell of buf                                                                                    blk -- stores address of nth block into buf                     alt -- switches between block and shadow (even) block                                                                           push -- push rest of buffer one cell ahead, for insert mode     pull -- pull rest of buffer one cell before, for insert mode                                                                   ( commands ) ( stopped copying from file here. insert 'count' blk )                                                             v: 'draw  : draw 'draw @ execute ;  : prep 3drop page ;         : .quit 3drop page bar quit ;                                   : .run prep run bar quit ; : .run@ prep run@ bar quit ;         : .top cx ind! ; : .bot len w - cx + ind! ;                     : .beg x0 ind! ; : .end x$ ind! ;         : .clr bufcl prnt ;   : .clrln where@ w cx - bl fill ind @ prnt ind! ;                : .delln .beg w 0 do bl wrt bl put loop y- .beg ;                                                                               : .nex begin x+ @bl? until ; : .prv begin x- @bl? until ;       : .blk+ blk+ draw ; : .blk- blk- draw ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( normal )                                                      : 2next dup 2over rot cells + 2@ dup 0<> ;                      : nokey 3drop 3drop rdrop ; : --- , ' , ;                       : dokey rot = if execute 3drop rdrop else drop 2 + then ;       create normal           'i --- noop   'Q --- .quit               'j --- y+ 'G --- .bot  'x --- .run@  'c --- .clrln 'J --- .blk+ 'k --- y- 'g --- .top  'X --- .run   'C --- noop   'K --- .blk- 'l --- x+ '$ --- .end  'w --- .nex   'D --- .delln 'A --- alt   ', --- x- '0 --- .beg  'b --- .prv   'S --- fsave   0 , 0 ,    does> 0 begin 2next if dokey else nokey then again ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( modes )                                                       v: mode                                                         : mode> mode @ execute ;                                        : keys key mode> ;                                              : >normal ['] normal mode ! ;                                   : insert esc? if drop >normal else bksp? dup wrt put then ;     : >insert ['] insert mode ! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ' >insert ' normal >body 1 cells + !                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( tui )                                                         : left 2 2 offs 2! ;                                            : blk. ." BLOCK " #blk @ 2/ 0 <# # #s #> type ;                 : blk. blu off h + at-xy blk. bnw ;                             : draw page bar left gre box iff blk. prnt ;                    : ldall 10 0 do i blk run loop ;                                ' draw 'draw !                                                  >normal                                                                                                                                                                                                                                                         : lis draw begin keys blk. bar refr again ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ⇩                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             