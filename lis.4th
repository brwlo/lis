( aux ) warnings off                                            : cc page clearstacks ; : ]l ] postpone literal ;               : v: variable ; : 2v: 2variable ; : vl: value ;                 : c: constant ; : 2c: 2constant ; : 3drop 2drop drop ;          : 3drop 2drop drop ; : not 0= ;                                 : 1= 1 = ; : 2= 2 = ; : 2+ 2 + ; : 2- 2 - ; : 10= 10 = ;        : i+ i + ; : i- i - ; : ++ rot + -rot + swap ;                  : even 2 mod 0= ; : odd 2 mod 0<> ; : s>num s>number drop ;     : sort 2dup max -rot min ; : -sort 2dup min -rot max ;          : +- dup even if 1+ else 1- then ;                              : winw form nip ; : winh form drop ;                            : 00xy 0 0 at-xy ; : 01xy 0 1 at-xy ;                                                                                           : bl? bl = ; : esc? dup 27 = ; : cr? dup 13 = ;                 : bksp? dup 127 = ; : digit? '0 '9 1+ within ;                                                                                  : .del ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( colors ) 2v: colr                                             30 c: black  31 c: red      32 c: green   33 c: yellow          34 c: blue   35 c: magenta  36 c: cyan    37 c: white           : digs 10 /mod '0 + swap '0 + swap emit emit ;                  : colo esc[ digs 'm emit ; : bg 10 + ;                          : colo> colr @ colo ; : swp colr 2@ swap colr 2! ;              : !remem colr @ swap colr 2! ;                                                                                                  : yellow! yellow colr ! ; : green! green colr ! ;               : white! white colr ! ; : red! red colr ! ;                     : blu blue colo ; : blubg blue bg colo ;                        : bnw black bg colo white colo ;                                                                                                                                                                                                                                                                                                ( files )                                                       v: file                                                         : fname" bl word count ;                                        : fmake r/w create-file ;                                       : fopen r/w open-file ;                                         : fmake drop fmake throw file ! ;                               : fopen 2dup fopen 0= if file ! 2drop exit then fmake ;         : fwrite file @ write-file throw ; ( appends )                  : fclose file @ close-file throw ;                              : "write fopen fwrite fclose ;                                  : write" ( buf len "file ) fname" "write ;                                                                                                                                                                                                                                                                                                                                                      ( boxes )                                                       : horiz 9473 xemit ; : topl 9487 xemit ; : topr 9491 xemit ;    : botr  9499 xemit ; : botl 9495 xemit ; : vert 9475 xemit ;                                                                    64 vl: w  16 vl: h  2v: offs                                    : len w h * ;                                                   : ofs offs 2@ ; : iff offs 2@ 1 1 ++ offs 2! ;                  : hor w 0 do horiz loop ;                                       : top ofs at-xy topl hor topr ;                                 : bot ofs h 1+ + at-xy botl hor botr ;                          : ver 1+ 2dup at-xy vert w 0 at-deltaxy vert ;                  : ver ofs h 0 do ver loop 2drop ;                               : box top ver bot ;                                                                                                             : bar 00xy blubg winw spaces 00xy .s bnw ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( blocks )                                                      64 c: #blks  len #blks * c: size  2v: #blk  v: buf              create blocks here size bl fill size allot                      : blk #blk ! blocks #blk @ len * + buf ! ;                      : blk% #blks mod blk ;                                          : blk+ #blk @ 2+ blk% ; : blk- #blk @ 2- blk% ;                 : shadw #blk @ +- ; : shadw! shadw blk ; : shadw? #blk @ odd ;  : alt #blk 2@ swap dup blk #blk 2! ;                                                                                            s" [ ! -e blocks.4th ] && touch blocks.4th" system              : fname s" blocks.4th" ; : file? fname slurp-file ;             : fread file? blocks swap move ;                                : fsave blocks size fname "write ;                              fread   0 blk                                                                                                                                                                                   (                                                                blocks                                                         2v: #blk v: buf                                                 : buf! block buf ! ;                                            : bufmem #blk @ swap #blk 2! ;                                  : blk dup bufmem buf! ;                                         : blk+ #blk @ 2+ blk ;                                          : blk- #blk @ 2- blk ;                                          : alt #blk 2@ swap dup buf! #blk 2! ;                           : shadw #blk @ +- ;                                             : shadw! shadw buf ! ;                                          : shadw? #blk @ odd ;                                            : .--> shadw run shadw ;                                                                                                                                                                        )                                                              ( cursor )                                                      v: ind                                                          : lim 0 max len 1- min ; : ind! lim ind ! ;                     : pos ind @ w /mod ; : cur pos ofs ++ ; : refr cur at-xy ;      : x+ ind @ 1+ ind! ; : x- ind @ 1- ind! ; : cx pos drop ;       : y+ ind @ w + ind! ; : y- ind @ w - ind! ; : cy pos nip ;      : x0 ind @ cx - ; : x$ ind @ w cx - 1- + ;                                                                                      : whe buf @ ind @ ; : where@ whe + ; : what where@ c@ ;         : bef whe 1- + c@ ; : aft whe 1+ + c@ ; : 2bef whe 2- + c@ ;    : beg? cx 0= ; : end? cx w 1- = ;                               : bob ind @ 0= ; : eob ind @ len 1- = ; : beob bob eob or ;     : buf@ buf @ len ;                                                                                                              : bef? bef bl? ; : aft? aft bl? ;                               : -bef? bef bl <> ; : -aft? aft bl <> ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( syntax ) : @bl? what bl? ; : -bl? what bl <> ; 2v: @syn       : !rem @syn @ swap @syn 2! ; : rem @syn 1 cells + @ @syn ! ;    : wrd? beg? bef? or aft? and ; : what? what = wrd? and ;        : int @syn @ 0= if yellow! rdrop then ;                         : )com @bl? bef ') = and 2bef bl? and ;                         : )com )com if swp rem rdrop then ;                             : com @syn @ 1= if white !remem )com rdrop then ;               : def @syn @ 2= if red! rdrop then ;                            : cmp @syn @ 4 = if green! rdrop then ;                         : com? '( what? if 1 !rem rdrop then ;                          : def? ': what? if 2 @syn ! rdrop then ;                        : ent? @syn @ 2 = -bl? and if 3 @syn ! rdrop then ;             : cmp? @syn @ 3 = @bl? and if 4 @syn ! rdrop then ;             : int? '; what? if @syn off rdrop then ;                        : syn? int? com? def? ent? cmp? int? ;                          : syn syn? int com def cmp ; : syn syn colo> ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( content )                                                     : run buf@ evaluate ; : run@ whe evaluate ;                     : nl y+ x0 ind! ; : nl? cr? over 10= or if nl drop rdrop then ; : put nl? syn emit x+ ; : wrt where@ c! ;                       : putbl ind @ x$ ind! bl wrt ind! refr ;                        : prnt len 0 do refr buf @ i + @ put loop ;                     : prnt ind off prnt ind off @syn off refr ;                     : bufcl buf @ len bl fill ; : prsrv ind @ prnt ind! refr ;      : pull where@ whe 1- + w cx - cmove putbl prsrv ;               : push where@ whe 1+ + w cx - 1- cmove> prsrv ;                 : ibksp? bksp? if pull x- drop rdrop then ;                     : rbksp? ibksp? if x- refr bl wrt bl emit refr drop rdrop then ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( buffers )                                                     : buf: create len allot ; buf: mov                              : >mov buf @ mov len move ;                                     : mov> mov buf @ len move ;                                     : bfswp >mov buf @ swap blk buf @ swap len move mov> ;          : bfswp #blk @ >r bfswp r> blk ;                                create ynk len allot                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( count )                                                       v: cmd v: cnt v: #cnt                                           : cntbf s"     " ;                                              : keep cmd ! ;                                                  : 0keep ['] noop keep ;                                         : 0cnt 0keep cnt off #cnt off s"    " drop cntbf move ;         : cnt+ #cnt @ 1+ dup #cnt ! 4 > if 0cnt then ;                  : >cnt cntbf drop #cnt @ + c! ;                                 : >cnt >cnt cntbf s>num cnt ! cnt+ ;                            : dig? cnt @ if '0 else '1 then '9 1+ within ;                  : cnt? dup dig? if >cnt rdrop then ;                            : cnt. cnt @ 0 <# # # # # #> type ;                             : reps cnt @ 1 max 0 do cmd @ execute loop 0cnt ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( commands ) v: lastk v: 'draw : draw 'draw @ execute ;         : prep page bar 01xy ; : .quit page bar 00xy quit ;             : -bl @bl? -aft? and eob or ; : till what = beob or ;           : .clr$ where@ w cx - bl fill ind @ prnt ind! ;                 : .clr key 'C = if bufcl prnt then ;                            : .run prep run quit ; : .run@ prep run@ quit ;                 : .blk+ blk+ draw ; : .blk- blk- draw ; : .alt alt draw ;       : .beg x0 ind! ; : .end x$ ind! ; : .top cx ind! ;              : .bot len w - cx + ind! ; : .del pull draw ;                   : .nex begin x+ @bl? -aft? and eob or until ;                   : .prv begin x- @bl? -bef? and bob or until ;                   : til+ begin lastk @ x+ till until ; : .til+ key lastk ! til+ ; : til- begin lastk @ x- till until ; : .til- key lastk ! til- ; : ln- .beg where@ whe w + + len ind @ - w - cmove> ;            : .ln- ln- where@ w bl fill prsrv ; : .ln+ y+ .ln- ;                                                                            : .shadw shadw! draw ; : .shswp shadw bfswp draw ;              : .bfswp cnt @ 2* bfswp 0cnt draw ; : .alt alt draw ;           : .>mov >mov draw ; : .mov> mov> draw ;                         : .bfgo cnt @ 2* blk 0cnt draw ;                                : .cpln .beg where@ ynk w move ;                                : .ptln .beg ynk where@ w move ;                                : delln .beg where@ w + where@ len ind @ w + - move ;           : delln delln .bot where@ w bl fill ;                           : .delln key 'D = if ind @ delln prnt ind! then ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( normal )                                                      : 2next dup 2over rot cells + 2@ dup 0<> ;                      : nokey 0keep 3drop 3drop rdrop ; : --- , ' , ;                 : dokey rot = if keep 3drop rdrop else drop 2+ then ;           create .normal 'i --- noop   'r --- noop   'B --- .bfgo          'j --- y+     'G --- .bot   'w --- .nex   'c --- .clr$          'k --- y-     'g --- .top   'b --- .prv   'C --- .clr           'l --- x+     '0 --- .beg   'x --- .run@  'd --- .del           ', --- x-     '$ --- .end   'X --- .run   'D --- .delln         'f --- .til+  'J --- .blk+  'o --- .ln+   'a --- .shadw         'F --- .til-  'K --- .blk-  'O --- .ln-   'A --- .alt           '; --- til+   't --- .shswp 'y --- .cpln  'p --- .ptln          ': --- til-   'T --- .bfswp 'Y --- .>mov  'P --- .mov>          'Q --- .quit  'S --- fsave   0 , 0 ,                           does> 0 begin 2next if dokey else nokey then again ;            : nrml cnt? .normal reps ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( modes )                                                       v: mode                                                         : mode> mode @ execute ;                                        : keys key mode> ;                                              : >nrml ['] nrml mode ! ;                                       : nrml? esc? if drop >nrml rdrop then ;                         : ins nrml? ibksp? push dup wrt put ;                           : rep nrml? rbksp? dup wrt put ;                                : >ins ['] ins mode ! ;                                         : >rep ['] rep mode ! ;                                         ' >ins ' .normal >body 1 cells + !                              ' >rep ' .normal >body 3 cells + !                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( config )                                                      : eq space 8656 xemit 8658 xemit space ;                        : bxcol shadw? if yellow else green then colo ;                 : shdw. shadw? if blu ofs 1- at-xy ." SHADOW" then ;            : left 2 2 offs 2! ; : dims 64 to w 16 to h ;                   : prt# 0 <# # # #> type ;                                       : cur. blu ofs w 6 - -1 ++ at-xy cx prt# bl emit cy prt# ;      : cnt. blu ofs w 5 - h ++ at-xy cnt. bnw ;                      : alt. eq #blk 2@ drop 2/ 0 <# # #s #> type ;                   : blk. ." BLK " #blk @ 2/ 0 <# # #s #> type alt. ;              : blk. blu ofs h + at-xy blk. bnw ;                             >nrml                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( tui )                                                         : empty s" ---marker--- marker ---marker---" evaluate ;         : draw page bar left bxcol box iff blk. cnt. shdw. prnt ;       ' draw 'draw !                                                                                                                  : lis draw begin keys blk. cur. cnt. bar refr again ;           marker ---marker---                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             lis                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                